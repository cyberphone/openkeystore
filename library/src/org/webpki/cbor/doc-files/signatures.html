<body>
<h2>1. Embedded Signatures</h2>
The CBOR library contains support for {@link CBORSigner Creating} 
and {@link CBORValidator Validating}
<i>embedded signatures</i> using a scheme called
&quot;CBOR Signature Format&quot; (CSF).
Unless otherwise noted, CBOR data is shown in
<a href='../package-summary.html#diagnostic-notation'>Diagnostic&nbsp;Notation</a>.
<p>
Note that unlike COSE 
[<a href='https://www.rfc-editor.org/rfc/rfc9052.html'>RFC9052</a>], CSF
leverages <a href='../package-summary.html#deterministic-encoding'>Deterministic&nbsp;Encoding</a>,
enabling constructs like the following:
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
{<br>
&nbsp;&nbsp;1: {<br>
&nbsp;&nbsp;&nbsp;&nbsp;1: "Space Shop",<br>
&nbsp;&nbsp;&nbsp;&nbsp;2: "435.00",<br>
&nbsp;&nbsp;&nbsp;&nbsp;3: "USD"<br>
&nbsp;&nbsp;},<br>
&nbsp;&nbsp;2: "spaceshop.com",<br>
&nbsp;&nbsp;3: "FR7630002111110020050014382",<br>
&nbsp;&nbsp;4: "https://banknet2.org",<br>
&nbsp;&nbsp;5: "05768401",<br>
&nbsp;&nbsp;6: "2025-04-23T09:34:08-05:00",<br>
&nbsp;&nbsp;7: {<br>
&nbsp;&nbsp;&nbsp;&nbsp;1: 38.8882,<br>
&nbsp;&nbsp;&nbsp;&nbsp;2: 77.0199<br>
&nbsp;&nbsp;},<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ Embedded signature object /</span><br>
&nbsp;&nbsp;simple(99): {<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ Signature algorithm = ESP256 /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;1: -9,<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ Public key descriptor in COSE format /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;4: {<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ kty = EC2 /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1: 2,<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ crv = P-256 /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1: 1,<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ x /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2: h'e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b5',<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ y /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-3: h'9826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d8'<br>
&nbsp;&nbsp;&nbsp;&nbsp;},<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ Signature value /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class='webpkihighlite'>6: h'05257a10ebea8ec582eef0dc9b0bffb2dfd0a1a0eda6bf0916672a9e53820b8412a465849bb086fbe3da94ae00dc5bf8b271fa0206fdd7c9ec909c4171b0d6b4'</span><br>
&nbsp;&nbsp;}<br>
}
</div>
</div>
<p>
The same object expressed as hex-encoded CBOR:
</p>
<div class='webpkihexbox'>
a801a3016a53706163652053686f7002663433352e30300363555344026d737061636573686f702e636f6d03781b465237363330303032313131313130303230303530303134333832047468747470733a2f2f62616e6b6e6574322e6f726705683035373638343031067819323032352d30342d32335430393a33343a30382d30353a303007a201fb404371b089a0275202fb405341460aa64c30f863a3012804a401022001215820e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b52258209826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d806584005257a10ebea8ec582eef0dc9b0bffb2dfd0a1a0eda6bf0916672a9e53820b8412a465849bb086fbe3da94ae00dc5bf8b271fa0206fdd7c9ec909c4171b0d6b4
</div>
<p>
    The sample was signed using the following COSE private key:
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
{<br>
&nbsp;&nbsp;1:&nbsp;2,<br>
&nbsp;&nbsp;-1:&nbsp;1,<br>
&nbsp;&nbsp;-2:&nbsp;h'e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b5',<br>
&nbsp;&nbsp;-3:&nbsp;h'9826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d8',<br>
&nbsp;&nbsp;-4:&nbsp;h'e97c4c15785c613e5037dc394c88366922ac6dc8fea63e019d990aed93ade01f'<br>
}
</div>
</div>
<i>Explanation: </i>
Labels <code>1</code>-<code>7</code> represent application data
(which for compatibility with CSF <b>must</b> be supplied in a CBOR <code>map</code>),
while the <i>reserved</i> label <code>simple(99)</code>
[<a href='https://datatracker.ietf.org/doc/draft-rundgren-cbor-simple-4-csf/'>I-D.draft-rundgren-cbor-simple-4-csf</a>]
holds the <i>embedded</i> signature container.
Note that application labels may be of any type.
<h2 id='csf-validation'>2. Signature Validation</h2>
Signatures <b>must</b> for compatibility with CSF,
be provided as a CBOR map having a fixed set of labels, 
according to the following table (with map values provided in CDDL
[<a href='https://www.rfc-editor.org/rfc/rfc8610.html'>RFC8610</a>]
notation):
<div class='webpkifloat'>
<table class='webpkitable'>
<tr><th>Name</th><th>Label</th><th>Value</th><th style='min-width:30em'>Comment</th></tr>

<tr><td><code class='webpkicode'>customData</code></td><td style='text-align:center'><code>0</code></td>
<td style='text-align:center'><code>any</code></td><td><i>Optional</i>: data included in the CSF container.
Also see <a href='crypto-options.html'>Crypto Options</a>.</td></tr>

<tr><td><code class='webpkicode'>algorithm</code></td><td style='text-align:center'><code>1</code></td>
<td style='text-align:center'><code>int</code></td><td>Signature algorithm using 
<a href='#csf-algorithms'>COSE&nbsp;identifiers</a>.</td></tr>

<tr><td><code class='webpkicode'>keyId</code></td><td style='text-align:center'><code>3</code></td>
<td style='text-align:center'><code>any</code><td><i>Optional</i>: key identifier using any valid CBOR object. 
Note that <code class='webpkicode'>keyId</code> <b>must not</b> be used together with 
<code class='webpkicode'>publicKey</code> or <code class='webpkicode'>certificatePath</code>.
A compliant <code class='webpkicode'>keyId</code> <b>must</b> uniquely identify a specific signature key.
</td></tr>

<tr><td><code class='webpkicode'>publicKey</code></td><td style='text-align:center'><code>4</code></td>
<td style='text-align:center'><code>{}</code></td>
<td><i>Optional</i>: public key in COSE format.  
Note that public key objects <b>must not</b> contain additional information like
key identifiers or preferred signature algorithms.
</td></tr>

<tr><td><code class='webpkicode'>certificatePath</code></td><td style='text-align:center'><code>5</code></td>
<td style='text-align:center'><code>[]</code></td><td><i>Optional</i>: certificate path supplied 
as an array of <code>byte&nbsp;string</code> objects holding X.509 certificates in DER format, 
where the first object <b>must</b> be the signature certificate.
Signature objects <b>must not</b> contain both <code class='webpkicode'>certificatePath</code> and <code class='webpkicode'>publicKey</code> elements.
</td></tr>

<tr><td><code class='webpkicode'>signatureValue</code></td><td style='text-align:center'><code>6</code></td>
<td style='text-align:center'><code>bstr</code></td><td>Signature value.
</td></tr>
</table>
</div>
To validate a CSF-based signature, apply the following set of rules:
<ul>
<li>Signatures are validated by running the signature validation 
<code class='webpkicode'>algorithm</code>,
over the CBOR binary representation of
the <code>map</code> object holding the application data
<i>including the embedded signature object</i>,
with the <code class='webpkicode'>signatureValue</code> label and
its associated value as the sole exception
(<span class='webpkihighlite'>highlighted</span> in the example).
Note that the length of the signature object <code>map</code> <b>must</b>
be updated to reflect the removal of the
<code class='webpkicode'>signatureValue</code> during validation.</li>
<li style='margin-top:0.5em'>Signature validation keys are either <i>implicit</i>, located via
<code class='webpkicode'>keyId</code> attributes,
or supplied in <code class='webpkicode'>publicKey</code> or
<code class='webpkicode'>certificatePath</code> attributes.</li>
<li style='margin-top:0.5em'>If <code class='webpkicode'>publicKey</code> or
<code class='webpkicode'>certificatePath</code> attributes are present,
they <b>must</b> be used as signature validation keys.
Note though that such keys <b>must</b> also be verified to be known and
trusted by the signature-using application.</li>
<li style='margin-top:0.5em'>Signature validation keys <b>must</b> be checked for compatibility with
the <code class='webpkicode'>algorithm</code> attribute.</li>
</ul>
<h2 id='csf-multiple-signatures'>3. Multiple Signatures</h2>
<p>
Multiple signatures use the same validation method as single signatures,
but have an enhanced syntax:
the reserved label <code>simple(99)</code> points to a <i>non-empty</i> array of signature
containers:
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
{<br>
&nbsp;&nbsp;1: "Hello signed world!",<br>
&nbsp;&nbsp;2: [4.7, true, h'012345'],<br>
&nbsp;&nbsp;simple(99): [{<br>
&nbsp;&nbsp;&nbsp;&nbsp;1: -19,<br>
&nbsp;&nbsp;&nbsp;&nbsp;4: {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1: 1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1: 6,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2: h'fe49acf5b92b6e923594f2e83368f680ac924be93cf533aecaf802e37757f8c9'<br>
&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&nbsp;&nbsp;&nbsp;&nbsp;6: h'692a8fac0a30b770797b61ab5b77f1c08f0653cb3569378094a98a326ed70eb20ccb20ba0278ed18cd40528e110009c572677d8ca66fba444678073898497000'<br>
&nbsp;&nbsp;}, {<br>
&nbsp;&nbsp;&nbsp;&nbsp;1: -9,<br>
&nbsp;&nbsp;&nbsp;&nbsp;4: {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1: 2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1: 1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2: h'e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b5',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-3: h'9826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d8'<br>
&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&nbsp;&nbsp;&nbsp;&nbsp;6: h'240861757ecede55cdbc2f0d33785f1e4b1b4e25c9cb5a6411e557ca6898cd083f39431d8e6c22661ff7aa2ee866f95acfc9b6be8510437c183a3c16b0d8cfd3'<br>
&nbsp;&nbsp;}]<br>
}
</div>
</div>
Validation is performed by validating each signature individually.
This is accomplished by removing other signatures (CSF containers),
leaving an array holding a single CSF container to the validation process.
<p>
Also se {@link CBORSigner#setMultiSignatureMode(boolean)} and {@link CBORValidator#setMultiSignatureMode(boolean)}.
</p>
<h2 id='csf-tagged-or-custom-data'>4. Tagged and Custom Signature Data</h2>
<p>
Through <a href='crypto-options.html'>Crypto Options</a>,
embedded signatures can be further enhanced, like the ability to
include a top-level object identifier in the signed data:
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
1010(["https://example.com/myobject", {<br>
&nbsp;&nbsp;1: "Hello signed world!",<br>
&nbsp;&nbsp;2: [4.7, true, h'012345'],<br>
&nbsp;&nbsp;simple(99): {<br>
&nbsp;&nbsp;&nbsp;&nbsp;1: -19,<br>
&nbsp;&nbsp;&nbsp;&nbsp;4: {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1: 1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1: 6,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2: h'fe49acf5b92b6e923594f2e83368f680ac924be93cf533aecaf802e37757f8c9'<br>
&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&nbsp;&nbsp;&nbsp;&nbsp;6: h'9bae93c35be09cc5aedb4167910f84bff63d834747c7ba592ec060a6f35300cdc9c2202252fc6cfe01156a12b547f1dca518658c30ce53bede620c398f6e4204'<br>
&nbsp;&nbsp;}<br>
}])
</div>
</div>
Note: the sample object features a 
<a href='https://www.ietf.org/archive/id/draft-rundgren-cotx-05.html'>COTX</a>
tag holding an URL based object identifier.
<h2 id='csf-unprotected-data'>5. Unprotected Data</h2>
In some cases there is a need to transport unprotected data in the signed
map.  This requires the use of the <i>reserved</i> label
{@link CBORCryptoConstants#CSF_UNPROTECTED_LBL}.
This feature is enabled through the method
{@link CBORValidator#setUnprotectedDataPolicy(CBORCryptoUtils.POLICY)}.
<p>
The following shows an example of a signed object holding unprotected data:
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
{<br>
&nbsp;&nbsp;1: "Hello signed world!",<br>
&nbsp;&nbsp;2: [4.7, true, h'012345'],<br>
&nbsp;&nbsp;simple(99): {<br>
&nbsp;&nbsp;&nbsp;&nbsp;1: -19,<br>
&nbsp;&nbsp;&nbsp;&nbsp;4: {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1: 1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1: 6,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2: h'fe49acf5b92b6e923594f2e83368f680ac924be93cf533aecaf802e37757f8c9'<br>
&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&nbsp;&nbsp;&nbsp;&nbsp;6: h'edc343e2740741fba9fe53c11e2428d301ffdfa7d1ca46482d85a26335ab707cb2813f0ac81d200bc2f84933cad5e87a3a7ff849816bc4e741b297e0c62eb30b'<br>
&nbsp;&nbsp;},<br>
&nbsp;&nbsp;simple(100): "Unprotected - Not signed"<br>
}
</div>
</div>
<h2 id='csf-algorithms'>6. Signature Algorithms</h2>
<div>
Currently supported COSE signature algorithms:
</div>
<div class='webpkifloat'>
<table class='webpkitable'>
<tr><th>Name</th><th>Identifier</th><th>Notes</th></tr>
<tr style='text-align:center'><td><code>HS256</code></td><td>5</td><td></td></tr>
<tr style='text-align:center'><td><code>HS384</code></td><td>6</td><td></td></tr>
<tr style='text-align:center'><td><code>HS512</code></td><td>7</td><td></td></tr>
<tr style='text-align:center'><td><code>Ed25519</code></td><td>-19</td><td>1</td></tr>
<tr style='text-align:center'><td><code>Ed448</code></td><td>-53</td><td>1</td></tr>
<tr style='text-align:center'><td><code>ESP256</code></td><td>-9</td><td>1</td></tr>
<tr style='text-align:center'><td><code>ESP384</code></td><td>-51</td><td>1</td></tr>
<tr style='text-align:center'><td><code>ESP512</code></td><td>-52</td><td>1</td></tr>
<tr style='text-align:center'><td><code>PS256</code></td><td>-37</td><td></td></tr>
<tr style='text-align:center'><td><code>PS384</code></td><td>-38</td><td></td></tr>
<tr style='text-align:center'><td><code>PS512</code></td><td>-39</td><td></td></tr>
<tr style='text-align:center'><td><code>RS256</code></td><td>-257</td><td></td></tr>
<tr style='text-align:center'><td><code>RS384</code></td><td>-258</td><td></td></tr>
<tr style='text-align:center'><td><code>RS512</code></td><td>-259</td><td></td></tr>
</table>
</div>
<p>
1] Updated for compliance with 
<a href='https://www.rfc-editor.org/rfc/rfc9864.html'>RFC9864</a>.
</p>
<h2 id='csf-test-vectors'>7. Test Vectors</h2>
An extensive set of test vectors is currently available at: 
<a href='https://github.com/cyberphone/openkeystore/tree/master/testdata/cbor-signatures'>
https://github.com/cyberphone/openkeystore/tree/master/testdata/cbor-signatures
</a>.
<p>
Use {@link org.webpki.tools.CBORPrinter} to list contents in a human-friendly way.
</p>
<h2 id='csf-api-usage'>8. Using the Signature API</h2>
The following section outlines how the signature API is supposed to be used.
<p>
Sample program:
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
#sample.program#
</div>
</div>
<p>
The resulting signed object:
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
#sample.program.diagnostic#
</div>
</div>
<p>
The resulting signed object expressed in hexadecimal:
</p>
<div class='webpkihexbox'>
#sample.program.hex#
</div>
</body>
